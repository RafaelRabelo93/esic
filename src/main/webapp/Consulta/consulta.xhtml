<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui">

<h:body>

	<ui:composition template="/templates/template.xhtml">

		<ui:define name="content">

			<div class="ficha">

				<!--		Mensagens de Erro		-->
				<p:messages id="messages" showDetail="true" autoUpdate="true"
					closable="true" />

				<h:outputText value="Consulta de solicitações" style="color:#1a568c; font-size:25px; padding-bottom: 1vw;" rendered="#{usuario.usuario.perfil ne '0' and usuario.usuario.perfil ne '1' }" />

				<h:panelGroup id="solicitacao_panel"
					rendered="#{usuario.usuario.perfil ne '0' and usuario.usuario.perfil ne '1' }">
					<p:dataTable id="solicitacoes" widget="solicitacoes" var="slt"
						emptyMessage="Nao há solicitação" sortBy="#{slt.status}"
						expandableRowGroups="false" 
						value="#{solicitacao.filteredSolicitacoes}"
						rowStyleClass="#{slt.status}" style="margin-bottom:1vw"
						filteredValue="#{solicitacao.filteredSolicitacoes}"
						paginator="true"
						paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
						rowsPerPageTemplate="5,10,15" rowKey="#{slt.idSolicitacao}">

<!-- 						<p:headerRow rendered="#{usuario.usuario.perfil eq '2' }"> -->
<!-- 							<p:column colspan="6" sortBy="#{slt.status}" priority="1"> -->
<!-- 								<h:outputText value="#{slt.status}" /> -->
<!-- 							</p:column> -->
<!-- 						</p:headerRow> -->

<!-- 						<p:headerRow> -->
<!-- 							<p:column colspan="8" sortBy="#{slt.status}" priority="1"> -->
<!-- 								<h:outputText value="#{slt.status}" /> -->
<!-- 							</p:column> -->
<!-- 						</p:headerRow> -->

						<p:column headerText="Protocolo" width="120" priority="6">
							<h:outputText value="#{slt.idSolicitacao}" />
						</p:column>

						<p:column headerText="Órgão" width="100" sortBy="#{slt.entidades.sigla}" priority="3">
							<h:outputText value="#{slt.entidades.sigla}" />
						</p:column>

						<p:column headerText="Título" sortBy="#{slt.titulo}" priority="3">
							<h:outputText value="#{slt.titulo}" />
						</p:column>

						<p:column headerText="Tipo" width="120" sortBy="#{slt.tipo}" priority="6">
							<h:outputText value="#{slt.tipo}" />
						</p:column>

						<p:column headerText="Status" width="100" sortBy="#{slt.status}" groupRow="true" priority="3">
							<h:outputText value="#{slt.status}" />
						</p:column>

						<p:column headerText="Cidadão" width="150"
							sortBy="#{slt.cidadao.usuario.nome}"
							rendered="#{usuario.usuario.perfil ne '3' }" priority="3">
							<h:outputText value="#{slt.cidadao.usuario.nome}" />
						</p:column>

						<p:column headerText="Data limite" sortBy="#{slt.dataLimite}" width="120" style="text-align:center"
						styleClass="prazo #{slt.status eq 'Finalizada' ? 'branco' : (slt.prazoTipo eq 3 ? 'verde' : (slt.prazoTipo eq 2 ? 'amarelo' : (slt.prazoTipo eq 1 ? 'vermelho' : 'branco')))}">
							<h:outputText value="#{slt.dataLimite}">
								<f:convertDateTime pattern="dd/MM/yyyy" timeZone="GMT-03:00" />
							</h:outputText>
						</p:column>
						
						<p:column headerText="Data final" sortBy="#{slt.datafim}" width="120" style="text-align:center">
							<h:outputText value=" ----------- " rendered="#{slt.datafim eq null}"/>
							<h:outputText value="#{slt.datafim}" rendered="#{slt.datafim ne null}">
								<f:convertDateTime pattern="dd/MM/yyyy" timeZone="GMT-03:00" />
							</h:outputText>
						</p:column>

						<p:column style="width:32px; text-align: center">
							<p:commandLink class="botaoLinkIcon" update="solicitacaoDetalhe"
								onclick="PF('detalheDialog').show(); PF('detalheDialog').toggleMaximize();">
								<i class="fa fa-search" />
								<f:setPropertyActionListener value="#{slt}"
									target="#{solicitacao.solicitacao}" />
								<f:setPropertyActionListener value="#{slt}" target="#{mensagem.solicitacao}" />
							</p:commandLink>
						</p:column>

					</p:dataTable>

				</h:panelGroup>

			</div>

<!-- Dialog Detalhe Solicitação -->
			<p:dialog widgetVar="detalheDialog" modal="true" showHeader="true"
				header="#{solicitacao.solicitacao.titulo}" fitViewport="true"
				showEffect="fade" hideEffect="fade" resizable="false"
				maximizable="false" draggable="false" closeOnEscape="true"
				onHide="PF('detalheDialog').toggleMaximize();"
				styleClass="solicitacaoDialog">
				<p:outputPanel id="solicitacaoDetalhe" style="display:flex; flex-flow: row">
					<h:panelGroup id="conteudo" style="padding: 10px">
					<p:panelGrid columns="2" layout="grid" style="border: none; width: 100%;">

						<h:outputText value="Protocolo:"
							style="color:#1a568c; font-size:18px" />
						<h:outputText value="#{solicitacao.solicitacao.protocolo}" />

						<h:outputText value="Orgao/ Entidade:"
							style="color:#1a568c; font-size:18px" />
						<h:outputText value="#{solicitacao.solicitacao.entidades.sigla} - #{solicitacao.solicitacao.entidades.nome}" />

						<h:outputText value="Tipo de solicitacao:"
							style="color:#1a568c; font-size:18px" />
						<h:outputText value="#{solicitacao.solicitacao.tipo}" />

						<h:outputText value="Status:" style="color:#1a568c; font-size:18px" />
						<h:outputText value="#{solicitacao.solicitacao.status}" />

						<h:outputText value="Instancia:"
							style="color:#1a568c; font-size:18px" />
						<h:outputText value="#{solicitacao.solicitacao.instancia}" />

						<h:outputText value="Data de Solicitacao:"
							style="color:#1a568c; font-size:18px" />
						<h:outputText value="#{solicitacao.solicitacao.dataIni}">
							<f:convertDateTime pattern="dd/MM/yyyy" timeZone="GMT-03:00" />
						</h:outputText>

						<h:outputText value="Data Limite:"
							style="color:#1a568c; font-size:18px" />
						<h:outputText value="#{solicitacao.solicitacao.dataLimite}">
							<f:convertDateTime pattern="dd/MM/yyyy" timeZone="GMT-03:00" />
						</h:outputText>

						<h:outputText value="Mensagens:"
							style="color:#1a568c; font-size:18px" />

					</p:panelGrid>

					<!-- Caixa de mensagens -->

						<p:tabView dynamic="true" cache="true">
							<p:tab title="Mensagens">
									<p:dataScroller value="#{mensagem.mensagensSolicitacao}"
										var="msg" chunkSize="2" rows="2" style="margin-bottom:1vw;">

										<f:facet name="loader">
											<p:commandLink id="outrasMsgs">
												<h:outputText value="Outras Mensagens" />
												<br />
												<i class="fa fa-caret-down" />
											</p:commandLink>
											<p:tooltip id="toolTipOutrasMsgs"
												value="Visualizar mensagens anteriores" for="outrasMsgs"
												position="top" style="box-shadow:none" />
										</f:facet>

										<p:outputPanel style="margin-top: 1vw;">
											<div class="mensagem">
												<h:outputText value="#{msg.usuario.nome}"
													style="color:#1a568c" />
												<h:outputText value="#{msg.data}" style="color:#1a568c">
													<f:convertDateTime pattern="d/M/yy - hh:mm"
														timeZone="GMT-03:00" />
												</h:outputText>
											</div>
											<h:outputText value="#{msg.texto}" style="margin-left:1vw" />

											<p:dataList value="#{msg.anexos}"
												rendered="#{msg.anexos.size() ne '0'}" var="anx">
												<h:outputLink value="#{anexo.downloadAnexo(msg)}">
													<h:outputText value="#{anexo.nomeView}" />
												</h:outputLink>
											</p:dataList>

										</p:outputPanel>

									</p:dataScroller>
							</p:tab>
							<p:tab title="Histórico da Solicitação">
								<p:dataScroller value="#{mensagem.mensagensHistorico}"
										var="msg" chunkSize="2" rows="2" style="margin-bottom:1vw;">

										<f:facet name="loader">
											<p:commandLink id="outrasMsgs">
												<h:outputText value="Outras Mensagens" />
												<br />
												<i class="fa fa-caret-down" />
											</p:commandLink>
											<p:tooltip id="toolTipOutrasMsgs"
												value="Visualizar mensagens anteriores" for="outrasMsgs"
												position="top" style="box-shadow:none" />
										</f:facet>

										<p:outputPanel style="margin-top: 1vw;">
											<div class="mensagem">
												<h:outputText value="#{msg.usuario.nome}"
													style="color:#1a568c" />
												<h:outputText value="#{msg.data}" style="color:#1a568c">
													<f:convertDateTime pattern="d/M/yy - hh:mm"
														timeZone="GMT-03:00" />
												</h:outputText>
											</div>
											<h:outputText value="#{msg.texto}" style="margin-left:1vw" />

											<p:dataList value="#{msg.anexos}"
												rendered="#{msg.anexos.size() ne '0'}" var="anx">
												<h:outputLink value="#{anexo.downloadAnexo(msg)}">
													<h:outputText value="#{anexo.nomeView}" />
												</h:outputLink>
											</p:dataList>

										</p:outputPanel>

									</p:dataScroller>
							</p:tab>
							<p:tab title="Trâmite Interno" rendered="#{usuario.usuario.perfil eq '2'}">
								<p:dataScroller value="#{mensagem.mensagensTramites}"
										var="msg" chunkSize="2" rows="2" style="margin-bottom:1vw;">

										<f:facet name="loader">
											<p:commandLink id="outrasMsgs">
												<h:outputText value="Outras Mensagens" />
												<br />
												<i class="fa fa-caret-down" />
											</p:commandLink>
											<p:tooltip id="toolTipOutrasMsgs"
												value="Visualizar mensagens anteriores" for="outrasMsgs"
												position="top" style="box-shadow:none" />
										</f:facet>

										<p:outputPanel style="margin-top: 1vw;">
											<div class="mensagem">
												<h:outputText value="#{msg.usuario.nome}"
													style="color:#1a568c" />
												<h:outputText value="#{msg.data}" style="color:#1a568c">
													<f:convertDateTime pattern="d/M/yy - hh:mm"
														timeZone="GMT-03:00" />
												</h:outputText>
											</div>
											<h:outputText value="#{msg.texto}" style="margin-left:1vw" />

											<p:dataList value="#{msg.anexos}"
												rendered="#{msg.anexos.size() ne '0'}" var="anx">
												<h:outputLink value="#{anexo.downloadAnexo(msg)}">
													<h:outputText value="#{anexo.nomeView}" />
												</h:outputLink>
											</p:dataList>

										</p:outputPanel>

									</p:dataScroller>
							</p:tab>
						</p:tabView>




					<h:form enctype="multipart/form-data">
						<p:outputPanel id="responderSolicitacao"
							rendered="#{(usuario.usuario.perfil eq '2' or usuario.usuario.perfil eq '4') and solicitacao.solicitacao.status ne 'Finalizada' and solicitacao.solicitacao.tipo ne 'Sugestão' and solicitacao.solicitacao.tipo ne 'elogio' }"
							style="display:flex; flex-flow: column">
							<p:panelGrid columns="1" style="width:100%">
								<p:outputLabel value="Mensagem de resposta: " for="mensagem" rendered="#{solicitacao.solicitacao.tipo ne 'Denúncia' }"/>
								<p:inputTextarea id="mensagem"
									value="#{mensagem.mensagem.texto}" maxlength="200"
									style="width:100%" rendered="#{solicitacao.solicitacao.tipo ne 'Denúncia' }"/>
									
								<p:outputLabel value="Status da Denúncia" for= "denunciaSelectMenu" rendered="#{solicitacao.solicitacao.tipo eq 'Denúncia' }" />
								<p:selectOneMenu value="" id="denunciaSelectMenu" rendered="#{solicitacao.solicitacao.tipo eq 'Denúncia' }">
								<f:selectItem itemLabel="Status1" itemValue="Status1"/> 
								<f:selectItem itemLabel="Status2" itemValue="Status2"/> 
								<f:selectItem itemLabel="Status3" itemValue="Status3"/> 
								</p:selectOneMenu>
								
								<p:outputLabel value="Anexo:"  rendered="#{solicitacao.solicitacao.tipo eq 'Solicitação' or solicitacao.solicitacao.tipo eq 'Informação' }"/>
								<p:outputLabel value="Descrição:" for="descricao" rendered="#{solicitacao.solicitacao.tipo eq 'Solicitação' or solicitacao.solicitacao.tipo eq 'Informação' }"/>
								<p:inputTextarea id="descricao" counter="display"
									maxlength="200" autoResize="false" style="width:100%"
									counterTemplate="{0} caracteres restantes."
									value="#{mensagem.anexo.descricao}" rendered="#{solicitacao.solicitacao.tipo eq 'Solicitação' or solicitacao.solicitacao.tipo eq 'Informação' }"/>
								<h:outputText id="display" rendered="#{solicitacao.solicitacao.tipo eq 'Solicitação' or solicitacao.solicitacao.tipo eq 'Informação' }"/>

								<p:fileUpload mode="simple" value="#{mensagem.file}"
									label="Enviar Arquivo" skinSimple="true"
									style="display: flex;  align-items: center;"
									allowTypes="/(\.|\/)(gif|jpe?g|png|pdf|txt|zip|rar|docx|doc|xls|xlsx|tar)$/"
									invalidFileMessage="São permitidos apenas arquivos de imagem (gif, jpeg, jpg, png), office(doc, docx, xls, xlsx), pdf,txt, zip, rar e tar."
									sizeLimit="1048576" rendered="#{solicitacao.solicitacao.tipo eq 'Solicitação' or solicitacao.solicitacao.tipo eq 'Informação' }"
									invalidSizeMessage="O tamanho máximo permitido é de 1MB." />
								<p:growl id="msg" />
							</p:panelGrid>

							<p:commandLink class="botaoLink" action="#{mensagem.save}"
								ajax="false" style="margin:1vw 0" update="solicitacao_panel detalheDialog">
								<h:outputText value="Responder" />
								<i class="fa fa-hand-o-up" />
								<f:setPropertyActionListener value="#{solicitacao.solicitacao}"
									target="#{mensagem.solicitacao}" />
							</p:commandLink>
						</p:outputPanel>
					</h:form>
					
					</h:panelGroup>
					
					<!-- 				Barra de ações -->
					<h:panelGroup id="barraBtns">
						
						<!-- Botão Resposta -->
						<p:commandLink action="#{solicitacao.recurso}" rendered="#{usuario.usuario.perfil ne '3'}" disabled="#{solicitacao.solicitacao.status eq 'Finalizada'}" styleClass="blankSquareBtn">
<!-- 							<h:panelGroup styleClass="blankSquareBtn"> -->
								<i class="fa fa-comments fa-3x" style="margin-bottom: 5px" />
								<h:outputText value="Responder" />
<!-- 							</h:panelGroup> -->
						</p:commandLink>
						
						<!-- Botão Prorrogar -->
						<p:commandLink class="botaoLink" styleClass="blankSquareBtn disable" rendered="#{usuario.usuario.perfil ne '3'}" disabled="#{!(solicitacao.solicitacao.status ne 'Finalizada' and 
						(solicitacao.solicitacao.tipo eq 'solicitacao' or solicitacao.solicitacao.tipo eq 'informacao' ) and solicitacao.ehProrrogavel() eq true)}">
							<i class="fa fa-clock-o fa-3x" style="margin-bottom: 5px"/>
							<h:outputText value="Prorrogar Resposta" />
							<f:setPropertyActionListener value="#{solicitacao.solicitacao}"	target="#{solicitacao.solicitacao}" />
						</p:commandLink>
						
						<!-- Botão Recurso -->
						<p:commandLink class="botaoLink" rendered="#{usuario.usuario.perfil eq '3' and solicitacao.solicitacao.tipo eq 'Informação'}" 
						disable="#{solicitacao.recursoLiberado() ne true and solicitacao.solicitacao.status eq 'finalizada'}"  onclick="PF('dlg2').show();" update="solicitacao_panel" styleClass="blankSquareBtn">
							<i class="fa fa-hand-o-up fa-3x" style="margin-bottom: 5px"/>
							<h:outputText value="Realizar Recurso" />
							<f:setPropertyActionListener value="Recurso" target="#{solicitacao.status}" />
							<f:setPropertyActionListener value="#{solicitacao.solicitacao}"	target="#{solicitacao.solicitacao}" />
						</p:commandLink>
					
					</h:panelGroup>
				</p:outputPanel>
			</p:dialog>
			
			<p:dialog header="Recurso" widgetVar="dlgRecurso" modal="true" showHeader="true" fitViewport="true" showEffect="fade" hideEffect="fade" resizable="false" maximizable="false" draggable="false" closeOnEscape="true">
				<h:form id="dialogRecurso">
					<p:outputPanel id="dlg" style="max-width: 690px">
						<p:panelGrid columns="1" style="border:none; width: 60%;">

							<p:outputLabel value="Descrição:" for="descr" />
							<p:inputTextarea id="descr" cols="100" rows="8" counter="display" maxlength="200"
								autoResize="false" style="width:100%" required="true"
								counterTemplate="{0} caracteres restantes." value="#{solicitacao.mensagem.texto}"/>
							<h:outputText id="display" />

						</p:panelGrid>

						<p:commandLink class="botaoLink"  style="margin: 0 .7vw 1vh 0; justify-self: flex-end;" action="#{solicitacao.recurso}" update="@all" oncomplete="PF('dlg2').hide();">
							<h:outputText value="Salvar" />
							<f:setPropertyActionListener value="Recurso" target="#{mensagem.status}" />
							<i class="fa fa-check" style="padding-left: 3px" />
						</p:commandLink>

					</p:outputPanel>
				</h:form>

			</p:dialog>

			<p:dialog header="Prorrogar" widgetVar="dlgProrrogar" modal="true" showHeader="true" fitViewport="true" showEffect="fade" 
				hideEffect="fade" resizable="false" maximizable="false" draggable="false" closeOnEscape="true">
				<h:form id="dialogProrrogar">
					<p:outputPanel id="dlg" style="max-width: 690px">
						<p:panelGrid columns="1" style="border:none; width: 60%;">

							<p:outputLabel value="Descrição:" for="descr" />
							<p:inputTextarea id="descr" cols="100" rows="8" counter="display" maxlength="200"
								autoResize="false" style="width:100%" required="true"
								counterTemplate="{0} caracteres restantes." value="#{solicitacao.mensagem.texto}"/>
							<h:outputText id="display" />

						</p:panelGrid>

						<p:commandLink class="botaoLink"  style="margin: 0 .7vw 1vh 0; justify-self: flex-end;" update="solicitacao_panel" action="#{solicitacao.prorrogar}"  oncomplete="PF('dlg3').hide();">
							<h:outputText value="Salvar" />
							<f:setPropertyActionListener value="Prorrogada" target="#{solicitacao.status}" />
							<i class="fa fa-check" style="padding-left: 3px" />
						</p:commandLink>

					</p:outputPanel>
				</h:form>

			</p:dialog>

			<p:dialog header="Encaminhar" widgetVar="dlgEncaminhar" modal="true" showHeader="true" fitViewport="true" showEffect="fade" 
				hideEffect="fade" resizable="false" maximizable="false" draggable="false" closeOnEscape="true">
				<h:form id="dialogEncaminhar">
					<p:outputPanel id="dlg" style="max-width: 690px">
						<p:panelGrid columns="1" style="border:none; width: 60%;">
						
							<p:outputLabel value="órgão/Entidade de destino" for="destino"/>
							<p:selectOneMenu id="destino" value="#{solicitacao.entReencaminhar}">
								<f:selectItem itemLabel="Selecione" noSelectionOption="true"/>
								<f:selectItems value="#{entidades.todasEntidades}" var="ent" itemLabel="#{ent.nome}" itemValue="#{ent}"/>
							</p:selectOneMenu>

							<p:outputLabel value="Justificativa Cidadão:" for="justCid" />
							<p:inputTextarea id="justCid" cols="100" rows="8" counter="display" maxlength="200"
								autoResize="false" style="width:100%" required="true"
								counterTemplate="{0} caracteres restantes." value="#{solicitacao.mensagem.texto}"/>
							<h:outputText id="display" />

							<p:outputLabel value="Justificativa Interna:" for="justInt" />
							<p:inputTextarea id="justInt" cols="100" rows="8" counter="display2" maxlength="200"
								autoResize="false" style="width:100%" required="true"
								counterTemplate="{0} caracteres restantes." value="#{solicitacao.mensagemEncaminhar.texto}"/>
							<h:outputText id="display2" />

						</p:panelGrid>

						<p:commandLink class="botaoLink"  style="margin: 0 .7vw 1vh 0; justify-self: flex-end;" update="solicitacao_panel" action="#{solicitacao.encaminhar()}"  oncomplete="PF('dlg3').hide();">
							<h:outputText value="Salvar" />
							<f:setPropertyActionListener value="Encaminhada" target="#{solicitacao.status}" />
							<i class="fa fa-check" style="padding-left: 3px" />
						</p:commandLink>

					</p:outputPanel>
				</h:form>

			</p:dialog>

		</ui:define>

	</ui:composition>

</h:body>

</html>