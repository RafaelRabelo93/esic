<?xml version="1.0" encoding="ISO-8859-1" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui">

<h:body>

	<ui:composition template="/templates/template.xhtml">

		<ui:define name="content">

			<div class="ficha">

				<!--		Mensagens de Erro		-->
				<p:messages id="messages" showDetail="true" autoUpdate="true"
					closable="true" />

				<h:outputText value="Consulta de solicitações"	style="color:#1a568c; font-size:25px; padding-bottom: 1vw;" rendered="#{usuario.usuario.perfil ne '0' and usuario.usuario.perfil ne '1' }" />


				<h:panelGroup id="solicitacao_panel" rendered="#{usuario.usuario.perfil ne '0' and usuario.usuario.perfil ne '1' }">
					<p:dataTable id="solicitacoes" widget="solicitacoes" var="slt"
						emptyMessage="Nao há solicitação" sortBy="#{slt.status}" expandableRowGroups="true" 
						value="#{solicitacao.filteredSolicitacoes}"
						style="margin-bottom:1vw" filteredValue="#{solicitacao.filteredSolicitacoes}" paginator="true"
						paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
           				rowsPerPageTemplate="5,10,15" rowKey="#{slt.idSolicitacao}">
           			
						<p:headerRow>
							<p:column colspan="6" sortBy="#{slt.status}" priority="1">
								<h:outputText value="#{slt.status}" />
							</p:column>
						</p:headerRow>
	
						<p:column headerText="Protocolo" priority="3">
							<h:outputText value="#{slt.idSolicitacao}"  />
						</p:column>

						<p:column headerText="Orgao/ Entidade" sortBy="#{slt.entidades.nome}" priority="3">
							<h:outputText value="#{slt.entidades.nome}" />
						</p:column>

						<p:column headerText="Tipo" sortBy="#{slt.tipo}" priority="3">
							<h:outputText value="#{slt.tipo}" />
						</p:column>

						<p:column headerText="Status" sortBy="#{slt.status}" priority="1" >
							<h:outputText value="#{slt.status}" />
						</p:column>

						<p:column headerText="Cidadao" sortBy="#{slt.cidadao.usuario.nome}" priority="3">
							<h:outputText value="#{slt.cidadao.usuario.nome}" />
						</p:column>

						<p:column headerText="Instancia" sortBy="#{slt.instancia}" priority="3">
							<h:outputText value="#{slt.instancia}" />
						</p:column>

						<p:column style="width:32px; text-align: center">
							<p:commandLink class="botaoLinkIcon" update="solicitacaoDetalhe"
								onclick="PF('detalheDialog').show(); PF('detalheDialog').toggleMaximize();">
								<i class="fa fa-search" />
								<f:setPropertyActionListener value="#{slt}"
									target="#{solicitacao.solicitacao}" />
							</p:commandLink>
						</p:column>
						
					</p:dataTable>

				</h:panelGroup>

			</div>

			<p:dialog widgetVar="detalheDialog" modal="true" showHeader="true" header="#{solicitacao.solicitacao.titulo}" fitViewport="true" showEffect="fade" hideEffect="fade" resizable="false" maximizable="false" draggable="false" closeOnEscape="true" onHide="PF('detalheDialog').toggleMaximize();" styleClass="consultaDialog">
				<p:outputPanel id="solicitacaoDetalhe"  style="display:flex; flex-flow: column">
					<p:panelGrid columns="2" layout="grid" style="border: none; width: 100%;">
		
							<h:outputText value="Protocolo:" style="color:#1a568c; font-size:18px"/>
							<h:outputText value="#{solicitacao.solicitacao.protocolo}" />

							<h:outputText value="Orgao/ Entidade:" style="color:#1a568c; font-size:18px" />
							<h:outputText value="#{solicitacao.solicitacao.entidades.nome}" />
			
							<h:outputText value="Tipo de solicitacao:" style="color:#1a568c; font-size:18px" />
							<h:outputText value="#{solicitacao.solicitacao.tipo}"  />
		
							<h:outputText value="Status:" style="color:#1a568c; font-size:18px" />
							<h:outputText value="#{solicitacao.solicitacao.status}"  />

							<h:outputText value="Instancia:" style="color:#1a568c; font-size:18px" />
							<h:outputText value="#{solicitacao.solicitacao.instancia}"  />

							<h:outputText value="Data de Solicitacao:" style="color:#1a568c; font-size:18px" />
							<h:outputText value="#{solicitacao.solicitacao.dataIni}"  />
							
							<h:outputText value="Data Limite:" style="color:#1a568c; font-size:18px" />
							<h:outputText value="#{solicitacao.solicitacao.dataLimite}"  />
							
							<h:outputText value="Mensagens:" style="color:#1a568c; font-size:18px" />
					</p:panelGrid>

					<p:dataScroller value="#{solicitacao.solicitacao.mensagems}" var="msg" chunkSize="2" rows="2" style="margin-bottom:1vw;">

						<f:facet name="loader">
							<p:commandLink id="outrasMsgs">
								<h:outputText value="Outras Mensagens" />
								<br />
								<i class="fa fa-caret-down" />
							</p:commandLink>
							<p:tooltip id="toolTipOutrasMsgs"
								value="Visualizar mensagens anteriores" for="outrasMsgs"
								position="top" style="box-shadow:none" />
						</f:facet>
					
						<p:outputPanel style="margin-top: 1vw;">
							<div class="mensagem">
								<h:outputText value="#{msg.usuario.nome}"  style="color:#1a568c" />
								<h:outputText value="#{msg.data}" style="color:#1a568c" />
							</div>
							<h:outputText value="#{msg.texto}" style="margin-left:1vw" />
								
							<p:dataList value="#{msg.anexos}" rendered="#{msg.anexos.size() ne '0'}" var="anx">
								<h:outputLink value="#{anexo.downloadAnexo(msg)}">
									<h:outputText value="#{anexo.nomeView}"/> 
								</h:outputLink>
							</p:dataList>
			
						</p:outputPanel>

					</p:dataScroller>
					
					<!-- 	Botão Realizar recurso -->
					<p:commandLink class="botaoLink" rendered="#{usuario.usuario.perfil eq '3' and solicitacao.solicitacao.status ne 'finalizada'}" 
								style="margin-bottom:1vw; align-self:flex-end" action="#{solicitacao.recurso}" update="solicitacao_panel" >
							<h:outputText value="Realizar Recurso" />
							<f:setPropertyActionListener value="Recurso" target="#{solicitacao.status}"/>
							<f:setPropertyActionListener value="#{solicitacao.solicitacao}" target="#{solicitacao.solicitacao}"/>
							<i class="fa fa-hand-o-up"/>
			         </p:commandLink>
			         
				<h:form enctype="multipart/form-data">
					<p:outputPanel id="responderSolicitacao" rendered="#{(usuario.usuario.perfil eq '2' or usuario.usuario.perfil eq '4') and solicitacao.solicitacao.status ne 'Finalizada'}" style="display:flex; flex-flow: column">
						<p:panelGrid columns="1" style="width:100%">
							<p:outputLabel value="Mensagem de resposta: " for="mensagem" />
							<p:inputText id="mensagem"
								rendered="#{usuario.usuario.perfil eq '2'}" 
								value="#{mensagem.mensagem.texto}" style="width:100%" />

							<p:outputLabel value="Anexo:" />
							<p:outputLabel value="Descrição:" for="descricao" />
							<p:inputTextarea id="descricao" counter="display" maxlength="200"
								autoResize="false" style="width:100%"
								counterTemplate="{0} caracteres restantes." value="#{mensagem.anexo.descricao}" />
							<h:outputText id="display" />

							<p:fileUpload mode="simple" value="#{mensagem.file}"
									label="Enviar Foto" skinSimple="true"
									style="display: flex;  align-items: center;"
									allowTypes="/(\.|\/)(gif|jpe?g|png|pdf|txt|zip|rar|docx|doc|xls|xlsx|tar)$/"
									invalidFileMessage="São permitidas somente imagens (gif, jpeg, jpg e png)"
									sizeLimit="1048576"
									invalidSizeMessage="O tamanho máximo permitido é de 1MB." />
									<p:growl id="msg" />
						</p:panelGrid>

						<p:commandLink class="botaoLink"  action="#{mensagem.save}" ajax="false" style="margin:1vw 0" update="solicitacao_panel" >
							<h:outputText value="Responder" />
							<i class="fa fa-hand-o-up" />
							<f:setPropertyActionListener value="#{solicitacao.solicitacao}" target="#{mensagem.solicitacao}" />
						</p:commandLink>

					</p:outputPanel>
				</h:form>	
						<p:commandLink class="botaoLink" rendered="#{usuario.usuario.perfil ne '3' and solicitacao.solicitacao.status ne 'Finalizada'}" action="#{solicitacao.prorrogar(solicitacao.solicitacao)}" update="solicitacao_panel" style="margin:1vw 0">
							<h:outputText value="Prorrogar Resposta" />
							<i class="fa fa-clock-o" />
							<f:setPropertyActionListener value="Prorrogada" target="#{solicitacao.status}"></f:setPropertyActionListener>
						</p:commandLink>
				</p:outputPanel>
			</p:dialog>

		</ui:define>

	</ui:composition>

</h:body>

</html>